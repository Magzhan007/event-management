{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'event_list' %}">Events</a></li>
      <li class="breadcrumb-item active" aria-current="page">
        {% if request.resolver_match.url_name == 'book_event' %}
          Book Event
        {% elif request.resolver_match.url_name == 'book_successfully' %}
          Booking Successful
        {% endif %}
      </li>
    </ol>
  </nav>
<div class="container mt-4 w-75">
    <h2 class="mb-4">Book {{ event.name }}</h2>

    {% if form.errors %}
    <div class="alert alert-danger">
        <strong>è¯·ä¿®æ­£ä»¥ä¸‹é”™è¯¯:</strong>
        <ul>
            {% for field in form %}
                {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        
        <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" value="{{ user.username }}" readonly>
        </div>
        <div class="mb-3">
            <label for="id_cus_ph" class="form-label">Contact Number</label>
            {{ form.cus_ph|add_class:"form-control"|attr:"pattern:^\\+?\\d{10,15}$"|attr:"title:For example +7(700)5550000 or 7005550000ï¼‰" }}
        </div>
        <div class="mb-3">
            <label for="id_booking_date" class="form-label">Booking Date</label>
            {{ form.booking_date|add_class:"form-control"|attr:"min:"|attr:"id:booking_date_input" }}
        </div>


        <h4 class="mt-4">Select Service Items</h4>
        <input type="hidden" id="base-price" value="{{ event.price }}">  <!-- ğŸŸ¢ åŸºç¡€ä»·æ ¼ -->

        {% for service in services %}
        <div class="mb-3">
            <label class="form-label">{{ service.service.name }}ï¼ˆDefault {{ service.default_quantity }}ï¼ŒMaximum {{ service.quantity_available }}ï¼‰</label>
            
            <div class="input-group">
                <!-- å‡å°‘æŒ‰é’® -->
                <button class="btn btn-outline-secondary decrement" type="button" data-target="service_{{ service.service.id }}">-</button>

                <!-- æ•°é‡è¾“å…¥æ¡† -->
                <input type="number" name="service_{{ service.service.id }}" 
                    id="service_{{ service.service.id }}" class="form-control service-quantity" 
                    min="0" max="{{ service.quantity_available }}" 
                    value="{{ service.default_quantity }}" 
                    data-price="{{ service.service.unit_price }}">

                <!-- å¢åŠ æŒ‰é’® -->
                <button class="btn btn-outline-secondary increment" type="button" data-target="service_{{ service.service.id }}">+</button>
            </div>
        </div>
        {% empty %}
        <p>There are no additional services for this event.</p>
        {% endfor %}

<!-- ğŸ”¥ å®æ—¶æ˜¾ç¤ºæ€»ä»· -->
<h4 class="mt-4">ğŸ’° Total Price: <span id="total-price">${{ event.price }}</span></h4>
        <button type="submit" class="btn btn-primary w-100 mb-4">Submit Booking</button>
    </form>
</div>
{% endblock %}


{% block script%}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„æœ€å°æ—¥æœŸä¸ºä»Šå¤©
        const today = new Date();
        const yyyy = today.getFullYear();
        let mm = today.getMonth() + 1; // æœˆä»½æ˜¯ä»0å¼€å§‹çš„
        let dd = today.getDate();
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
        if (dd < 10) dd = '0' + dd;
        if (mm < 10) mm = '0' + mm;
        
        const formattedToday = yyyy + '-' + mm + '-' + dd;
        
        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„æœ€å°å€¼ä¸ºä»Šå¤©
        const dateInput = document.getElementById('booking_date_input');
        if (dateInput) {
            dateInput.setAttribute('min', formattedToday);
            
            // æ·»åŠ éªŒè¯ï¼Œç¡®ä¿ç”¨æˆ·ä¸èƒ½æ‰‹åŠ¨è¾“å…¥è¿‡å»çš„æ—¥æœŸ
            dateInput.addEventListener('input', function() {
                const selectedDate = new Date(this.value);
                const currentDate = new Date();
                
                // é‡ç½®æ—¶é—´éƒ¨åˆ†ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
                currentDate.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < currentDate) {
                    alert('æ— æ³•é€‰æ‹©è¿‡å»çš„æ—¥æœŸ');
                    this.value = formattedToday;
                }
            });
        }

        function updateTotalPrice() {
            let basePrice = parseFloat(document.getElementById("base-price").value);
            let totalPrice = basePrice;
    
            document.querySelectorAll(".service-quantity").forEach(input => {
                let quantity = parseInt(input.value) || 0;
                let unitPrice = parseFloat(input.getAttribute("data-price"));
                totalPrice += quantity * unitPrice;
            });
    
            document.getElementById("total-price").textContent = `$${totalPrice.toFixed(2)}`;
        }
    
        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
        document.querySelectorAll(".service-quantity").forEach(input => {
            input.addEventListener("input", updateTotalPrice);
        });
    
        // ç›‘å¬ + - æŒ‰é’®
        document.querySelectorAll(".increment").forEach(button => {
            button.addEventListener("click", function () {
                let targetId = this.getAttribute("data-target");
                let input = document.getElementById(targetId);
                let max = parseInt(input.max);
                let value = parseInt(input.value) || 0;
                if (value < max) {
                    input.value = value + 1;
                    updateTotalPrice();
                }
            });
        });
    
        document.querySelectorAll(".decrement").forEach(button => {
            button.addEventListener("click", function () {
                let targetId = this.getAttribute("data-target");
                let input = document.getElementById(targetId);
                let value = parseInt(input.value) || 0;
                if (value > 0) {
                    input.value = value - 1;
                    updateTotalPrice();
                }
            });
        });
    
        // åˆå§‹åŒ–æ€»ä»·
        updateTotalPrice();
    });
    </script>
{% endblock%}